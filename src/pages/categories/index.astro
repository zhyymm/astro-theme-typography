---
import LayoutDefault from '~/layouts/LayoutDefault.astro'
import { getCollection, type CollectionEntry } from 'astro:content'
import { generateSlug } from '~/utils/slugify'

const { translate: t } = Astro.locals
type Post = CollectionEntry<'posts'>;

const allPosts = await getCollection('posts', post => !post.data.draft)

// --- 分类统计逻辑 ---
const categoryMap = new Map<string, { name: string, count: number, slug: string }>()

allPosts.forEach((post: Post) => {
    const categories: string[] = post.data.categories ?? [];
    categories.forEach(chineseName => {
        const rawSlug = generateSlug(chineseName);
        const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseName;

        const entry = categoryMap.get(chineseName) || { name: chineseName, count: 0, slug: slug };
        entry.count += 1;
        categoryMap.set(chineseName, entry);
    });
});

const categoryList = Array.from(categoryMap.values()).map(item => ({
    title: item.name,
    href: `/categories/${encodeURIComponent(item.slug)}/`,
    count: item.count,
}));

// --- 标签统计逻辑 ---
const tagCountMap = new Map<string, { count: number, slug: string }>()

allPosts.forEach((post: Post) => {
    const tags: string[] = post.data.tags ?? [];
    tags.forEach((chineseTag: string) => {
        const rawTagSlug = generateSlug(chineseTag);
        const tagSlug = (rawTagSlug && rawTagSlug.trim() !== '') ? rawTagSlug : chineseTag;

        const entry = tagCountMap.get(chineseTag) || { count: 0, slug: tagSlug };
        entry.count += 1;
        tagCountMap.set(chineseTag, entry);
    });
});

const sortedTags = [...tagCountMap.entries()]
  .sort((a, b) => b[1].count - a[1].count)
  .slice(0, 50)
---

<LayoutDefault>
  <div class="py-8">
    <header class="mb-12 border-b border-zinc-200 dark:border-zinc-800 pb-6">
      <h1 class="text-2xl font-bold mb-2">{t('Categories')}</h1>
      <p class="text-sm opacity-50 italic">根据经藏与法义主题进行的分类汇总</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8 mb-16">
      {
        categoryList.map(({ title, href, count }) => (
          <div class="group flex items-center justify-between border-b border-dotted border-zinc-200 dark:border-zinc-700 pb-2">
            <h3 class="text-lg font-medium">
              <a href={href} class="group-hover:text-orange-500 transition-colors">
                <span class="opacity-30 mr-1">#</span>{title}
              </a>
            </h3>
            <span class="text-xs opacity-40 tabular-nums">
              {count} 篇文章
            </span>
          </div>
        ))
      }
    </div>

    {sortedTags.length > 0 && (
      <div class="mt-20">
        <h3 class="text-xl font-bold mb-8 flex items-center">
          <span class="w-1.5 h-6 bg-orange-500 mr-3"></span>
          全站热门标签
        </h3>
        <div class="flex flex-wrap gap-3">
          {sortedTags.map(([chineseTag, data]) => (
            <a
              href={`/tags/${encodeURIComponent(data.slug)}/`}
              class="inline-flex items-center px-3 py-1.5 bg-zinc-100 dark:bg-zinc-800 hover:bg-orange-500/10 border border-transparent hover:border-orange-500/30 rounded text-sm transition-all group"
            >
              <span class="opacity-50 group-hover:text-orange-500 group-hover:opacity-100 mr-1">#</span>
              <span class="font-medium group-hover:text-orange-500">{chineseTag}</span>
              <span class="ml-2 text-xs opacity-30 tabular-nums">{data.count}</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
  
</LayoutDefault>