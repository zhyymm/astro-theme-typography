---
import PostMeta from '~/components/PostMeta.astro'
import type { Post } from '~/types'
import Giscus from '~/components/comments/Giscus.astro'
import LayoutDefault from '~/layouts/LayoutDefault.astro'

interface Props {
  post: Post
  prev?: any  // 新增
  next?: any  // 新增
}

const { post, prev, next } = Astro.props
const { source, commentsUrl } = post.data

const isPostPage = Astro.url.pathname.startsWith('/posts/')
const authorSlug = post.data.author || "admin"
const authorDisplayName = post.data.authorName || authorSlug
---

<article class="prose relative">
  <article class={`prose relative ${isPostPage ? 'post-detailed' : ''}`}>
    <PostMeta post={post} />

    {/* 1. 根据是否为详情页，决定是否包裹折叠层 */}
    {isPostPage ? (
      <div id="post-content-wrapper" class="relative overflow-hidden max-h-[1200px] transition-[max-height] duration-500 ease-in-out">
        <slot />
        <div id="read-more-mask" class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-white dark:from-zinc-950 to-transparent z-10"></div>
      </div>
    ) : (
      /* 主页预览：不加任何包裹容器，直接渲染内容 */
      <slot />
    )}

    {/* 2. 展开按钮：仅在详情页渲染 */}
    {isPostPage && (
      <div id="read-more-btn-container" class="flex justify-center mt-4">
        <button id="read-more-btn" class="px-6 py-2 border border-orange-500/30 text-orange-500 rounded-full hover:bg-orange-500 hover:text-white transition-all text-sm font-bold flex items-center gap-2">
          阅读全文
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </button>
      </div>
    )}

    {/* 3. 法义来源：仅在详情页显示 */}
    {isPostPage && source && (
      <div class="mt-12 p-4 bg-zinc-50 dark:bg-zinc-900/40 border-l-4 border-orange-500/50 text-sm italic rounded-r-lg">
        <span class="opacity-40 text-[10px] uppercase tracking-widest block mb-1 font-bold">法义来源 / Reference</span>
        <a href={source.url} target="_blank" rel="noopener noreferrer" class="text-orange-600 dark:text-orange-400 hover:text-orange-700 transition-colors no-underline border-b border-orange-500/20 pb-0.5">
          {source.title} →
        </a>
      </div>
    )}
  </article>
{/* 4. 作者信息栏 */}
{isPostPage && (
  <div class="mt-12 pt-8 border-t border-dashed border-zinc-200 dark:border-zinc-800">
    <div class="flex items-center justify-between flex-wrap gap-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full bg-orange-500/5 flex items-center justify-center text-lg shadow-sm border border-orange-500/10 font-bold text-orange-500">
          {authorDisplayName.charAt(0)}
        </div>
        <div class="flex flex-col">
          <span class="text-[10px] opacity-40 uppercase tracking-widest font-bold">本文作者</span>
          <a 
    href={`/authors/${authorSlug}/`} 
    class="text-base font-bold transition-all no-underline px-2 py-0.5 rounded-none hover:!bg-zinc-800 hover:!text-orange-500"
  >
            {authorDisplayName}
          </a>
        </div>
      </div>

      {commentsUrl && (
        <a href={commentsUrl} target="_blank" class="px-4 py-2 text-xs border border-orange-500/20 text-orange-500 rounded-full hover:bg-orange-500 hover:text-white transition-all no-underline">
          参与本篇讨论
        </a>
      )}
    </div>
    <p class="text-xs opacity-50 mt-4 italic leading-relaxed">
      如法受持，如实开示。点击作者名查看更多导师详情。
    </p>
  </div>
)}
<nav class="not-prose mt-12 pt-8 border-t border-dashed border-zinc-200 dark:border-zinc-800">
  <div class="nav-container">
    
    {/* 上一篇：靠左 */}
    <div class="nav-wrapper left">
      {prev && (
        <a href={`/posts/${prev.id.replace(/\.(md|mdx)$/, '')}/`} class="nav-link group">
          <span class="nav-prefix">« 上一篇:</span>
          <span class="nav-title">{prev.data.title}</span>
        </a>
      )}
    </div>

    {/* 下一篇：靠右 */}
    <div class="nav-wrapper right">
      {next && (
        <a href={`/posts/${next.id.replace(/\.(md|mdx)$/, '')}/`} class="nav-link group">
          <span class="nav-title">{next.data.title}</span>
          <span class="nav-prefix">:下一篇 »</span>
        </a>
      )}
    </div>

  </div>
</nav>

<style>
  /* 1. 基础布局：电脑两端对齐，手机上下堆叠 */
  .nav-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;
  }

  @media (min-width: 768px) {
    .nav-container {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
  }

  /* 2. 槽位控制：确保左右分布 */
  .nav-wrapper {
    flex: 1;
    display: flex;
    min-width: 0;
  }
  
  .nav-wrapper.right {
    justify-content: flex-end;
  }

  /* 3. 链接样式：单行、圆角标签感 */
  .nav-link {
    display: inline-flex !important;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    text-decoration: none !important;
    transition: all 0.2s ease;
    border-radius: 4px;
    background: transparent;
    max-width: 100%;
    white-space: nowrap; /* 强制不换行 */
  }

  /* 4. 悬停状态：黑底橙字 */
  .nav-link:hover {
    background-color: #18181b !important; /* zinc-900 */
  }
  
  :global(.dark) .nav-link:hover {
    background-color: #f4f4f5 !important; /* zinc-100 */
  }

  .nav-prefix {
    font-size: 13px;
    color: #a1a1aa; /* zinc-400 */
    flex-shrink: 0;
  }

  .nav-title {
    font-size: 14px;
    font-weight: 500;
    color: #52525b; /* zinc-600 */
    overflow: hidden;
    text-overflow: ellipsis; /* 标题过长显示省略号 */
  }

  .nav-link:hover .nav-title {
    color: #ea580c !important; /* orange-600 */
  }

  /* 5. 手机端细节优化：消除滑动时的框架感 */
  @media (max-width: 640px) {
    .nav-link {
      padding: 4px 0; /* 平时无内边距，文字对齐文章边缘 */
    }
    .nav-link:hover, .nav-link:active {
      padding: 4px 10px; /* 点击时才展开色块 */
    }
    .nav-title {
      font-size: 13px;
    }
  }

  /* 深色模式文字基础颜色 */
  :global(.dark) .nav-title {
    color: #d4d4d8;
  }
</style>
{/* 5. 评论区 */}
{isPostPage && (
  <section class="giscus-container mt-12">
    <Giscus />
  </section>
)}


<script is:inline>
  function initReadMore() {
    const wrapper = document.getElementById('post-content-wrapper');
    const btn = document.getElementById('read-more-btn');
    const mask = document.getElementById('read-more-mask');
    const container = document.getElementById('read-more-btn-container');

    if (!wrapper || !btn) return;

    // 检查内容高度
    if (wrapper.scrollHeight <= 1200) {
      wrapper.style.maxHeight = 'none';
      container.style.display = 'none';
      mask.style.display = 'none';
    } else {
      wrapper.style.maxHeight = '1200px';
      container.style.display = 'flex';
      mask.style.display = 'block';
    }

    btn.onclick = () => {
      wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
      mask.style.opacity = '0';
      setTimeout(() => {
        mask.style.display = 'none';
        container.style.display = 'none';
        wrapper.style.maxHeight = 'none';
      }, 500);
    };
  }

  // 立即执行并监听 Astro 路由切换
  initReadMore();
  document.addEventListener('astro:after-swap', initReadMore);
</script>