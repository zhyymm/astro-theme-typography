---
// src/components/comments/Giscus.astro
---

<div
  id="cusdis_thread"
  data-host="https://zhy.de5.net"
  data-app-id="0f96ecd2-1356-419c-a590-b1ba57ad3932"
  data-page-id={Astro.url.pathname}
  data-page-url={Astro.url.href}
  data-page-title={Astro.props.title || ""}
  data-theme="auto" 
></div>

<script is:inline>
  (function() {
    window.CUSDIS = {};
    let iframeInstance;

    function createIframe(target) {
      const host = (target.dataset.host || 'https://zhy.de5.net').replace(/\/$/, '');
      const iframeJsPath = `${host}/js/iframe.umd.js`;
      const cssPath = `${host}/js/style.css`;

      if (iframeInstance) return iframeInstance;

      iframeInstance = document.createElement('iframe');
      
      // 这里的 srcdoc 增加了对深色模式的兼容处理
      iframeInstance.srcdoc = `<!DOCTYPE html>
        <html>
          <head>
            <link rel="stylesheet" href="${cssPath}">
            <base target="_parent" />
            <script>
              window.CUSDIS_LOCALE = ${JSON.stringify(window.CUSDIS_LOCALE || {})}
              window.__DATA__ = ${JSON.stringify(target.dataset)}
              window.__DATA__.host = "${host}"; 
            <\/script>
            <style>
              :root { color-scheme: light dark; }
              /* 隐藏原生的边框和外边距，让它更像原生组件 */
              body { margin: 0; padding: 10px 0; font-family: system-ui, -apple-system, sans-serif; }
              #root { padding: 0 !important; }
              /* 微调按钮样式，使其更圆润 */
              .cusdis-btn { border-radius: 8px !important; transition: all 0.2s; }
              /* 调整输入框间距 */
              .cusdis-input { border-radius: 6px !important; border: 1px solid #e2e8f0 !important; }
            </style>
          </head>
          <body>
            <div id="root"></div>
            <script src="${iframeJsPath}" type="module"><\/script>
          </body>
        </html>`;

      iframeInstance.style.width = '100%';
      iframeInstance.style.border = '0';
      iframeInstance.style.minHeight = '480px';
      iframeInstance.style.display = 'block';

      window.addEventListener('message', (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.from === 'cusdis' && msg.event === 'resize') {
            iframeInstance.style.height = msg.data + 'px';
          }
        } catch (err) {}
      });

      return iframeInstance;
    }

    function renderCusdis() {
      const container = document.getElementById('cusdis_thread');
      if (container) {
        container.innerHTML = '';
        iframeInstance = null;
        const iframe = createIframe(container);
        container.appendChild(iframe);
      }
    }

    document.addEventListener('astro:page-load', renderCusdis);
    if (document.readyState === 'complete') {
      renderCusdis();
    } else {
      window.addEventListener('load', renderCusdis);
    }
  })();
</script>

<style is:global>
  /* 外部容器：去掉多余的强制边距和重复的边框 */
  #cusdis_thread {
    min-height: auto !important;
    width: 100% !important;
    /* 这里的边距交给 Layout 控制，组件本身保持干净 */
    margin-top: 0 !important;
    padding-top: 0 !important;
    border-top: none !important;
  }

  /* 如果你想保留组件自带的标题，可以留着；
     如果你想用 Layout 里的对齐样式，就把 ::before 这段删掉 */
  #cusdis_thread::before {
    content: "留言讨论";
    display: block;
    font-size: 1.1rem; /* 稍微调小一点，更精致 */
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--tw-prose-headings, #1a202c);
  }
</style>