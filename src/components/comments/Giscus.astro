---
// src/components/comments/Giscus.astro
---

<div
  id="cusdis_thread"
  data-host="https://zhy.de5.net"
  data-app-id="0f96ecd2-1356-419c-a590-b1ba57ad3932"
  data-page-id={Astro.url.pathname}
  data-page-url={Astro.url.href}
  data-page-title={Astro.props.title || ""}
></div>

<script is:inline>
  // 1. 直接注入 Cusdis 核心逻辑，彻底消灭 404 隐患
  (function() {
    window.CUSDIS = {};
    let iframeInstance;

    function createIframe(target) {
      if (iframeInstance) return iframeInstance;

      iframeInstance = document.createElement('iframe');
      const host = target.dataset.host || 'https://zhy.de5.net';
      const iframeJsPath = `${host}/js/iframe.umd.js`;
      const cssPath = `${host}/js/style.css`;

      // 直接在这里硬编码生成 iframe 的内容
      iframeInstance.srcdoc = `<!DOCTYPE html>
        <html>
          <head>
            <link rel="stylesheet" href="${cssPath}">
            <base target="_parent" />
            <script>
              window.CUSDIS_LOCALE = ${JSON.stringify(window.CUSDIS_LOCALE || {})}
              window.__DATA__ = ${JSON.stringify(target.dataset)}
            <\/script>
            <style>:root { color-scheme: light; }</style>
          </head>
          <body>
            <div id="root"></div>
            <script src="${iframeJsPath}" type="module"><\/script>
          </body>
        </html>`;

      iframeInstance.style.width = '100%';
      iframeInstance.style.border = '0';
      iframeInstance.style.minHeight = '480px';

      // 监听消息（处理高度自适应等）
      window.addEventListener('message', (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.from === 'cusdis' && msg.event === 'resize') {
            iframeInstance.style.height = msg.data + 'px';
          }
        } catch (err) {}
      });

      return iframeInstance;
    }

    function renderCusdis() {
      const container = document.getElementById('cusdis_thread');
      if (container) {
        container.innerHTML = '';
        const iframe = createIframe(container);
        container.appendChild(iframe);
      }
    }

    // 适配 Astro 的视图过渡 (View Transitions)
    document.addEventListener('astro:page-load', renderCusdis);
    // 首次加载兼容
    if (document.readyState === 'complete') {
      renderCusdis();
    } else {
      window.addEventListener('load', renderCusdis);
    }
  })();
</script>

<style is:global>
  #cusdis_thread {
    min-height: 480px !important;
    width: 100% !important;
    border-top: 1px solid #eee;
    margin-top: 2rem;
    padding-top: 2rem;
  }
</style>