---
// src/pages/tags/[...tag].astro

import { getCollection } from 'astro:content';
import LayoutDefault from '~/layouts/LayoutDefault.astro';
import { formatDate } from '~/utils';
import type { Post } from '~/types';
import { generateSlug } from '~/utils/slugify';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', post => !post.data.draft);
  const tagMap = new Map<string, { name: string, posts: Post[] }>();

  allPosts.forEach((post: Post) => {
    const tags: string[] = post.data.tags ?? [];
    tags.forEach((chineseTag: string) => {
      // 这里的生成逻辑必须与全站保持绝对一致
      const rawSlug = generateSlug(chineseTag);
      const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseTag;

      if (slug) {
        const entry = tagMap.get(slug) || { name: chineseTag, posts: [] };
        entry.posts.push(post);
        tagMap.set(slug, entry);
      }
    });
  });

  return Array.from(tagMap.entries()).map(([slug, data]) => ({
    params: { tag: slug },
    props: { posts: data.posts, name: data.name },
  }));
}

// 这里的 name 是标签的中文名，posts 是该标签下的文章数组
const { posts, name } = Astro.props as { posts: Post[], name: string };

// 格式化列表项数据
function getListItems(posts: Post[]) {
  return posts.map((post: Post) => ({
    title: post.data.title,
    href: `/posts/${post.slug || post.id}/`,
    date: formatDate(post.data.pubDate),
  }));
}

const listItems = getListItems(posts);
---

<LayoutDefault>
  <section class="container mx-auto px-4 py-12">
    <div class="mb-8 border-b pb-4">
      <h1 class="text-3xl md:text-3xl font-bold text-center md:text-left">
        # {name}
      </h1>
      <p class="text-gray-500 mt-2 text-center md:text-left">
        共计 {posts.length} 篇文章
      </p>
    </div>

    <ul class="pl-6 py-3 space-y-6">
      {
        listItems.map((item) => (
          <li class="flex flex-col md:flex-row md:items-baseline gap-2">
            <time class="text-gray-400 text-sm tabular-nums min-w-[100px]">
              {item.date}
            </time>
            <h3 class="post-title text-xl font-medium">
              <a href={item.href} class="hover:text-primary transition-colors">
                {item.title}
              </a>
            </h3>
          </li>
        ))
      }
    </ul>

    {posts.length === 0 && (
        <p class="text-center text-gray-500 py-12 text-lg">
            该标签下暂无文章。
        </p>
    )}
  </section>
</LayoutDefault>