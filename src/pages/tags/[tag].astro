---
// src/pages/tags/[...tag].astro

import { getCollection } from 'astro:content';
import LayoutDefault from '~/layouts/LayoutDefault.astro';
import { formatDate } from '~/utils';
import type { Post } from '~/types';
import { generateSlug } from '~/utils/slugify';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', post => !post.data.draft);
  const tagMap = new Map<string, { name: string, posts: Post[] }>();

  allPosts.forEach((post: Post) => {
    const tags: string[] = post.data.tags ?? [];
    tags.forEach((chineseTag: string) => {
      const rawSlug = generateSlug(chineseTag);
      const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseTag;

      if (slug) {
        const entry = tagMap.get(slug) || { name: chineseTag, posts: [] };
        entry.posts.push(post);
        tagMap.set(slug, entry);
      }
    });
  });

  return Array.from(tagMap.entries()).map(([slug, data]) => ({
    params: { tag: slug },
    props: { posts: data.posts, name: data.name },
  }));
}

const { posts, name } = Astro.props as { posts: Post[], name: string };

// 按时间降序排列文章
const sortedPosts = posts.sort((a, b) => {
  return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});

function getListItems(posts: Post[]) {
  return posts.map((post: Post) => ({
    title: post.data.title,
    href: `/posts/${post.slug || post.id}/`,
    date: formatDate(post.data.pubDate, 'YYYY-MM-DD'),
  }));
}

const listItems = getListItems(sortedPosts);
---

<LayoutDefault>
  <div class="py-8">
    <header class="mb-10 border-b border-zinc-200 dark:border-zinc-800 pb-6">
      <div class="text-xs opacity-50 mb-2 tracking-widest uppercase">Tag Archives</div>
      <h1 class="text-2xl font-bold text-orange-500">
        <span class="opacity-30">#</span> {name}
      </h1>
      <p class="text-sm opacity-40 mt-2">
        共计收录 {posts.length} 篇相关文章
      </p>
    </header>

    <ul class="flex flex-col gap-4">
      {
        listItems.map((item) => (
          <li class="group flex flex-col md:flex-row md:items-center justify-between gap-2 border-b border-dotted border-zinc-100 dark:border-zinc-800/50 pb-2">
            <h3 class="text-base font-medium">
              <a href={item.href} class="group-hover:text-orange-500 transition-colors">
                {item.title}
              </a>
            </h3>
            <time class="text-xs opacity-30 tabular-nums font-mono">
              {item.date}
            </time>
          </li>
        ))
      }
    </ul>

    {posts.length === 0 && (
        <div class="py-20 text-center">
            <p class="opacity-30 italic text-sm">空空如也，此中无物。</p>
        </div>
    )}
  </div>
</LayoutDefault>