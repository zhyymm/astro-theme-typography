---
import { getCollection, getEntry } from 'astro:content';
import LayoutDefault from '~/layouts/LayoutDefault.astro';
import { formatDate } from '~/utils';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', post => !post.data.draft);
  const uniqueAuthors = [...new Set(allPosts.map(post => post.data.author || "default"))];

  return uniqueAuthors.map(authorSlug => ({
    params: { author: authorSlug },
    props: {
      slug: authorSlug,
      posts: allPosts.filter(p => (p.data.author || "default") === authorSlug)
    },
  }));
}

const { slug, posts } = Astro.props;
const sortedPosts = posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const authorEntry = await getEntry('authors', slug);
const displayName = authorEntry?.data?.name || (slug.charAt(0).toUpperCase() + slug.slice(1));
const profile = authorEntry ? authorEntry.data : { title: "求道者", bio: "如法受持", avatar: null };

let Content = null;
if (authorEntry) {
  const rendered = await authorEntry.render();
  Content = rendered.Content;
}
---

<LayoutDefault>
  <div class="py-8 max-w-4xl mx-auto">   <header class="mb-16 border-b border-zinc-200 dark:border-zinc-800 pb-12">
                                             <div class="flow-root">

                                               <div class="float-left mr-10 mb-6 group relative">
                                                 {profile.avatar ? (
                                                   <img
                                                     src={profile.avatar}
                                                     alt={displayName}
                                                     class="w-32 h-32 rounded-full object-cover border-4 border-white dark:border-zinc-800 shadow-xl"
                                                   />
                                                 ) : (
                                                   <div class="w-32 h-32 rounded-full bg-orange-500/5 text-orange-600 text-5xl flex items-center justify-center border border-orange-500/10 font-serif font-bold">
                                                     {displayName.charAt(0)}
                                                   </div>
                                                 )}
                                               </div>

                                               <div class="author-content">
                                                 <h1 class="text-3xl font-bold mb-2 tracking-tight">{displayName}</h1>
                                                 <p class="text-sm opacity-60 font-medium tracking-widest text-zinc-500 dark:text-zinc-400 mb-6 uppercase">
                                                   {profile.title}
                                                 </p>

                                                 <div class="prose prose-orange dark:prose-invert max-w-none
                                                             prose-p:leading-relaxed prose-p:text-zinc-600 dark:prose-p:text-zinc-300
                                                             prose-headings:text-zinc-800 dark:prose-headings:text-zinc-200">
                                                   {Content ? (
                                                       <Content />
                                                   ) : (
                                                     <p class="italic opacity-50">{profile.bio}</p>
                                                   )}
                                                 </div>
                                               </div>
                                             </div>
                                           </header>

    <section class="max-w-2xl md:ml-[10.5rem]"> <h2 class="text-lg font-bold mb-6 flex items-center opacity-80">
        <span class="w-1.5 h-1.5 rounded-full bg-orange-500 mr-3"></span> 法音集录 ({posts.length})
      </h2>
      <ul class="flex flex-col gap-5">
        {sortedPosts.map((post) => (
          <li class="group flex flex-col sm:flex-row sm:items-center justify-between gap-2 border-b border-zinc-100 dark:border-zinc-800/50 pb-3">
            <h3 class="text-base">
              <a href={`/posts/${post.slug || post.id}/`} class="group-hover:text-orange-500 transition-colors duration-300">
                {post.data.title}
              </a>
            </h3>
            <time class="text-[11px] opacity-30 tabular-nums font-mono tracking-tighter">
              {formatDate(post.data.pubDate, 'YYYY-MM-DD')}
            </time>
          </li>
        ))}
      </ul>
    </section>
  </div>
</LayoutDefault>