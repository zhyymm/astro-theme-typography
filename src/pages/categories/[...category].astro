---
import { getCollection } from 'astro:content';
import LayoutDefault from '~/layouts/LayoutDefault.astro';
import { formatDate } from '~/utils';
import type { Post } from '~/types';
import { generateSlug } from '~/utils/slugify';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', post => !post.data.draft);
  const categoryMap = new Map<string, { name: string, posts: Post[] }>();

  allPosts.forEach((post: Post) => {
    const categories: string[] = post.data.categories ?? [];
    categories.forEach(chineseName => {
      const rawSlug = generateSlug(chineseName);
      const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseName;

      if (slug) {
        const entry = categoryMap.get(slug) || { name: chineseName, posts: [] };
        entry.posts.push(post);
        categoryMap.set(slug, entry);
      }
    });
  });

  return Array.from(categoryMap.entries()).map(([slug, data]) => ({
    params: { category: slug },
    props: { posts: data.posts, name: data.name },
  }));
}

const { posts, name } = Astro.props as { posts: Post[], name: string };

// 逻辑统一：按日期降序排列
const sortedPosts = posts.sort((a, b) => {
  return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});

function getListItems(posts: Post[]) {
  return posts.map((post: Post) => ({
    title: post.data.title,
    href: `/posts/${post.slug || post.id}/`,
    date: formatDate(post.data.pubDate, 'YYYY-MM-DD'),
  }));
}

const listItems = getListItems(sortedPosts);
---

<LayoutDefault>
  <div class="py-8">
    <header class="mb-10 border-b border-zinc-200 dark:border-zinc-800 pb-6">
      <div class="text-xs opacity-50 mb-2 tracking-widest uppercase text-zinc-400">Category Collection</div>
      <h1 class="text-2xl font-bold text-orange-600 dark:text-orange-500">
        <span class="opacity-20 mr-1">/</span> {name}
      </h1>
      <p class="text-sm opacity-40 mt-2">
        该栏目下共收录 {posts.length} 篇文献
      </p>
    </header>

    <ul class="flex flex-col gap-4">
      {
        listItems.map((item) => (
          <li class="group flex flex-col md:flex-row md:items-center justify-between gap-2 border-b border-dotted border-zinc-100 dark:border-zinc-800/50 pb-2">
            <h3 class="text-base font-medium">
              <a href={item.href} class="group-hover:text-orange-500 transition-colors">
                {item.title}
              </a>
            </h3>
            <time class="text-xs opacity-30 tabular-nums font-mono italic">
              {item.date}
            </time>
          </li>
        ))
      }
    </ul>

    {posts.length === 0 && (
      <div class="py-20 text-center">
        <p class="opacity-20 italic text-sm">此分类下暂无内容。</p>
      </div>
    )}
  </div>
</LayoutDefault>