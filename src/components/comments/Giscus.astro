---
// src/components/comments/Giscus.astro
---

<div
  id="cusdis_thread"
  data-host="https://zhy.de5.net"
  data-app-id="0f96ecd2-1356-419c-a590-b1ba57ad3932"
  data-page-id={Astro.url.pathname}
  data-page-url={Astro.url.href}
  data-page-title={Astro.props.title || ""}
></div>

<script is:inline>
  (function() {
    window.CUSDIS = {};
    let iframeInstance;

    function createIframe(target) {
      // 修正1：确保 host 结尾没有多余斜杠，避免路径拼接错误
      const host = (target.dataset.host || 'https://zhy.de5.net').replace(/\/$/, '');
      const iframeJsPath = `${host}/js/iframe.umd.js`;
      const cssPath = `${host}/js/style.css`;

      if (iframeInstance) return iframeInstance;

      iframeInstance = document.createElement('iframe');
      
      // 修正2：在 window.__DATA__ 中显式传递 host，确保 iframe 内部知道往哪发请求
      iframeInstance.srcdoc = `<!DOCTYPE html>
        <html>
          <head>
            <link rel="stylesheet" href="${cssPath}">
            <base target="_parent" />
            <script>
              window.CUSDIS_LOCALE = ${JSON.stringify(window.CUSDIS_LOCALE || {})}
              window.__DATA__ = ${JSON.stringify(target.dataset)}
              // 强制指定数据发送的目标地址
              window.__DATA__.host = "${host}"; 
            <\/script>
            <style>:root { color-scheme: light; }</style>
          </head>
          <body>
            <div id="root"></div>
            <script src="${iframeJsPath}" type="module"><\/script>
          </body>
        </html>`;

      iframeInstance.style.width = '100%';
      iframeInstance.style.border = '0';
      iframeInstance.style.minHeight = '480px';

      window.addEventListener('message', (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.from === 'cusdis' && msg.event === 'resize') {
            iframeInstance.style.height = msg.data + 'px';
          }
        } catch (err) {}
      });

      return iframeInstance;
    }

    function renderCusdis() {
      const container = document.getElementById('cusdis_thread');
      if (container) {
        container.innerHTML = '';
        iframeInstance = null; // 修正3：重置实例，确保切换页面时重新绑定数据
        const iframe = createIframe(container);
        container.appendChild(iframe);
      }
    }

    document.addEventListener('astro:page-load', renderCusdis);
    if (document.readyState === 'complete') {
      renderCusdis();
    } else {
      window.addEventListener('load', renderCusdis);
    }
  })();
</script>

<style is:global>
  #cusdis_thread {
    min-height: 480px !important;
    width: 100% !important;
    margin-top: 2rem;
  }
</style>