---
// src/pages/categories/[...category].astro

import { getCollection } from 'astro:content';
import LayoutDefault from '~/layouts/LayoutDefault.astro';
import { formatDate } from '~/utils';
import type { Post } from '~/types';
import { generateSlug } from '~/utils/slugify';

// 1. 修改 getStaticPaths 逻辑
export async function getStaticPaths() {
  const allPosts = await getCollection('posts', post => !post.data.draft);

  // 创建 Map 来存储 {Slug: {name: 中文名, posts: Post[]}}
  const categoryMap = new Map<string, { name: string, posts: Post[] }>();

  allPosts.forEach((post: Post) => {
      const categories: string[] = post.data.categories ?? [];

      if (categories.length > 0) {
          const chineseName: string = categories[0];

          // ⭐ 关键修复逻辑：与 PostMeta 保持一致
          const rawSlug = generateSlug(chineseName);
          // 如果 generateSlug 无法处理中文返回了空字符串，我们就直接使用中文名作为路由
          const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseName;

          if (slug) {
              const entry = categoryMap.get(slug) || { name: chineseName, posts: [] };
              entry.posts.push(post);
              categoryMap.set(slug, entry);
          }
      }
  });

  // 2. 生成路径：Astro 会自动处理 params 里的中文编码
  return Array.from(categoryMap.entries()).map(([slug, data]) => {
    return {
      params: { category: slug }, // 这里的 slug 可能是英文也可能是中文“巴利三藏”
      props: { posts: data.posts, name: data.name },
    }
  });
}

// 获取 props
const { posts, name } = Astro.props as { posts: Post[], name: string };

// 3. 修改标签计数逻辑，确保这里的标签链接也不会变成 undefined
const tagCountMap = new Map<string, { count: number, slug: string }>();

posts.forEach((post: Post) => {
  const tags: string[] = post.data.tags ?? [];

  if (tags.length > 0) {
    tags.forEach((chineseTag: string) => {
      // ⭐ 同样应用安全回退逻辑
      const rawTagSlug = generateSlug(chineseTag);
      const tagSlug = (rawTagSlug && rawTagSlug.trim() !== '') ? rawTagSlug : chineseTag;

      const entry = tagCountMap.get(chineseTag) || { count: 0, slug: tagSlug };
      entry.count += 1;
      entry.slug = tagSlug;
      tagCountMap.set(chineseTag, entry);
    });
  }
});

const sortedTags = [...tagCountMap.entries()].sort((a, b) => b[1].count - a[1].count);

function getListItems(posts: Post[]) {
  const result = posts.map((post: Post) => ({
    title: post.data.title,
    href: `/posts/${post.slug || post.id}/`, // 建议加上 fallback 确保链接有效
    date: formatDate(post.data.pubDate),
  }));
  return result;
}
---

<LayoutDefault>
  <section class="container mx-auto px-4 py-12">
    <h1 class="text-3xl md:text-3xl font-bold mb-5 text-center md:text-left">
        # {name}
    </h1>

    {sortedTags.length > 0 && (
      <div class="mt-6 mb-10">
        <p class="text-lg font-medium mb-4 text-gray-700">本分类常用标签</p>
        <div class="flex flex-wrap gap-3">
          {sortedTags.map(([chineseTag, data]) => (
            <a
              href={`/tags/${encodeURIComponent(data.slug)}/`}
              class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200
                     rounded-full text-sm transition-colors shadow-sm hover:shadow"
            >
              <span>#{chineseTag}</span>
              <span class="ml-1.5 text-xs text-gray-500">({data.count})</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <ul class="pl-6 py-3" flex="~ col gap-4">
      {
        getListItems(posts).map((item) => (
          <li>
            <h3 class="post-title">
              <a href={item.href}>{item.title}</a>
            </h3>
            <time>{item.date}</time>
          </li>
        ))
      }
    </ul>

    {posts.length === 0 && (
        <p class="text-center text-gray-500 py-12 text-lg">
            该分类下暂无文章。
        </p>
    )}
  </section>
</LayoutDefault>