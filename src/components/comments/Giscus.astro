---
// src/components/comments/Giscus.astro
---

<div
  id="cusdis_thread"
  data-host="https://zhy.de5.net"
  data-app-id="0f96ecd2-1356-419c-a590-b1ba57ad3932"
  data-page-id={Astro.url.pathname}
  data-page-url={Astro.url.href}
  data-page-title={Astro.props.title || ""}
  data-theme="auto" 
></div>

<script is:inline>
  (function() {
    window.CUSDIS = {};
    let iframeInstance;

    function createIframe(target) {
      const host = (target.dataset.host || 'https://zhy.de5.net').replace(/\/$/, '');
      const iframeJsPath = `${host}/js/iframe.umd.js`;
      const cssPath = `${host}/js/style.css`;

      if (iframeInstance) return iframeInstance;

      iframeInstance = document.createElement('iframe');
      
      iframeInstance.srcdoc = `<!DOCTYPE html>
        <html>
          <head>
            <link rel="stylesheet" href="${cssPath}">
            <base target="_parent" />
            <script>
              window.CUSDIS_LOCALE = ${JSON.stringify(window.CUSDIS_LOCALE || {})}
              window.__DATA__ = ${JSON.stringify(target.dataset)}
              window.__DATA__.host = "${host}"; 
            <\/script>
            <style>
              :root { color-scheme: light dark; }
              /* 【修改点 1】将 padding 从 10px 改为 0，彻底贴合 */
              body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
              #root { padding: 0 !important; }
              .cusdis-btn { border-radius: 8px !important; transition: all 0.2s; }
              .cusdis-input { border-radius: 6px !important; border: 1px solid #e2e8f0 !important; }
            </style>
          </head>
          <body>
            <div id="root"></div>
            <script src="${iframeJsPath}" type="module"><\/script>
          </body>
        </html>`;

      iframeInstance.style.width = '100%';
      iframeInstance.style.border = '0';
      /* 【修改点 2】将 480px 改为 150px 甚至更小，防止下方出现大片空白 */
      iframeInstance.style.minHeight = '150px'; 
      iframeInstance.style.display = 'block';

      window.addEventListener('message', (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.from === 'cusdis' && msg.event === 'resize') {
            iframeInstance.style.height = msg.data + 'px';
          }
        } catch (err) {}
      });

      return iframeInstance;
    }

    function renderCusdis() {
      const container = document.getElementById('cusdis_thread');
      if (container) {
        container.innerHTML = '';
        iframeInstance = null;
        const iframe = createIframe(container);
        container.appendChild(iframe);
      }
    }

    document.addEventListener('astro:page-load', renderCusdis);
    if (document.readyState === 'complete') {
      renderCusdis();
    } else {
      window.addEventListener('load', renderCusdis);
    }
  })();
</script>

<style is:global>
  #cusdis_thread {
    min-height: auto !important; 
    width: 100% !important;
    margin-top: 0 !important;
    /* 【修改点 3】增加一个负边距尝试抵消一些外部组件带来的强制空白（可选） */
    margin-bottom: 0px !important; 
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    border-top: none !important;
  }

  #cusdis_thread iframe {
    margin-bottom: 0 !important;
    display: block !important;
  }
</style>