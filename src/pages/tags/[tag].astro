---
import { getCollection } from 'astro:content';

import Layout from '../../layouts/LayoutDefault.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');

  const uniqueTags = new Set<string>();

  allPosts.forEach(post => {
    if (!post.data.draft) {
      post.data.tags?.forEach(tag => {
        if (tag && typeof tag === 'string') {
          uniqueTags.add(tag.trim());
        }
      });
    }
  });

  return Array.from(uniqueTags).map(tag => ({
    params: { tag }
  }));
}

const { tag } = Astro.params;

const posts = (await getCollection('posts'))
  .filter(post => 
    !post.data.draft && 
    post.data.tags?.includes(tag)
  )
  .sort((a, b) => {
    const dateA = a.data.modDate ?? a.data.pubDate;
    const dateB = b.data.modDate ?? b.data.pubDate;
    return dateB.valueOf() - dateA.valueOf();
  });
---

<Layout title={`#${tag} - ç¦æ™ºåŒä¿®`}>
  <main class="container mx-auto px-3 py-12">
    <h1 class="text-2xl font-bold mb-3 flex items-center gap-3">
      <span>ğŸ·ï¸</span> #{tag}
    </h1>

    <a href="/tags/" class="text-blue-600 hover:underline mb-8 inline-block">
      â† è¿”å›æ‰€æœ‰æ ‡ç­¾
    </a>

    <p class="text-lg text-gray-600 mb-2">
      å…±æ‰¾åˆ° {posts.length} ç¯‡æ–‡ç« 
    </p>

    {posts.length === 0 ? (
      <div class="text-center py-12 text-gray-500">
        è¿™ä¸ªæ ‡ç­¾ä¸‹æš‚æ—¶æ²¡æœ‰æ–‡ç« ...
      </div>
    ) : (
      <div class="space-y-8">
        {posts.map(post => (
          <article class="border-b border-gray-200 pb-6 last:border-0">
            <a
              href={`/posts/${post.id}/`}
              class="block hover:opacity-80 transition-opacity"
            >
              <h2 class="text-xl font-semibold mb-2 hover:text-blue-600 transition-colors">
                {post.data.title}
              </h2>
            </a>

            <div class="text-sm text-gray-600 flex flex-wrap gap-3">
              <time>
                {(post.data.modDate ?? post.data.pubDate).toLocaleDateString('zh-CN')}
              </time>

              {post.data.categories?.length > 0 && (
                <>
                  Â·
                  {post.data.categories.map(cat => (
                    <a
                      href={`/categories/${cat}`}
                      class="text-blue-600 hover:underline hover:text-blue-800 transition-colors"
                    >
                      {cat}
                    </a>
                  ))}
                </>
              )}
            </div>
          </article>
        ))}
      </div>
    )}
  </main>
</Layout>