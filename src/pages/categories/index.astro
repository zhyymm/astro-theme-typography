---
import LayoutDefault from '~/layouts/LayoutDefault.astro'
import { getCollection, type CollectionEntry } from 'astro:content'
import { generateSlug } from '~/utils/slugify'

const { translate: t } = Astro.locals
type Post = CollectionEntry<'posts'>;

const allPosts = await getCollection('posts', post => !post.data.draft)

// --- 分类统计逻辑 ---
const categoryMap = new Map<string, { name: string, count: number, slug: string }>()

allPosts.forEach((post: Post) => {
    const categories: string[] = post.data.categories ?? [];
    categories.forEach(chineseName => {
        const rawSlug = generateSlug(chineseName);
        const slug = (rawSlug && rawSlug.trim() !== '') ? rawSlug : chineseName;

        const entry = categoryMap.get(chineseName) || { name: chineseName, count: 0, slug: slug };
        entry.count += 1;
        categoryMap.set(chineseName, entry);
    });
});

const categoryList = Array.from(categoryMap.values()).map(item => ({
    title: item.name,
    href: `/categories/${encodeURIComponent(item.slug)}/`,
    count: item.count,
}));

// --- 标签统计逻辑 ---
const tagCountMap = new Map<string, { count: number, slug: string }>()

allPosts.forEach((post: Post) => {
    const tags: string[] = post.data.tags ?? [];
    tags.forEach((chineseTag: string) => {
        const rawTagSlug = generateSlug(chineseTag);
        const tagSlug = (rawTagSlug && rawTagSlug.trim() !== '') ? rawTagSlug : chineseTag;

        const entry = tagCountMap.get(chineseTag) || { count: 0, slug: tagSlug };
        entry.count += 1;
        tagCountMap.set(chineseTag, entry);
    });
});

const sortedTags = [...tagCountMap.entries()]
  .sort((a, b) => b[1].count - a[1].count)
  .slice(0, 50)
---

<LayoutDefault>
  <section class="container mx-auto px-4 py-12">
    <h2 class="post-title text-4xl font-bold mb-10">{t('Categories')}</h2>

    <ul class="mb-16 flex flex-col gap-10">
      {
        categoryList.map(({ title, href, count }) => (
          <li class="group">
            <h3 class="post-title text-2xl font-semibold mb-2">
              <a href={href} class="hover:text-primary transition-colors">
                # {title}
              </a>
            </h3>
            <p class="text-gray-400 text-base">
              {count} 篇文章
            </p>
          </li>
        ))
      }
    </ul>

    <hr class="border-gray-100 mb-12" />

    {sortedTags.length > 0 && (
      <div class="mt-12">
        <h3 class="text-2xl font-bold mb-8">全站热门标签</h3>
        <div class="flex flex-wrap gap-4">
          {sortedTags.map(([chineseTag, data]) => (
            <a
              href={`/tags/${encodeURIComponent(data.slug)}/`}
              class="inline-flex items-center px-4 py-2 bg-gray-50 hover:bg-gray-100 border border-gray-100 rounded-full text-base transition-all hover:shadow-sm"
            >
              <span class="text-primary font-medium">#{chineseTag}</span>
              <span class="ml-2 text-sm text-gray-400">({data.count})</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </section>
</LayoutDefault>